<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spencer's Masonry - Bid Calculator</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1a1a; min-height: 100vh; color: #ffffff; }
        .header { background: #f97316; padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; box-shadow: 0 2px 10px rgba(249, 115, 22, 0.3); }
        .header h1 { font-size: 1.2rem; color: white; }
        .header-controls { display: flex; align-items: center; gap: 12px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: #f97316; color: white; }
        .btn-primary:hover { background: #ea580c; }
        .btn-success { background: #16a34a; color: white; }
        .btn-success:hover { background: #15803d; }
        .btn-secondary { background: #404040; color: #ffffff; }
        .btn-secondary:hover { background: #525252; }
        .btn-back { background: rgba(255,255,255,0.2); color: white; padding: 10px 16px; text-decoration: none; display: inline-flex; align-items: center; gap: 6px; border-radius: 8px; font-weight: 600; font-size: 0.95rem; }
        .btn-back:hover { background: rgba(255,255,255,0.3); }
        .btn-small { padding: 6px 12px; font-size: 0.85rem; }
        .btn-danger { background: #dc2626; color: white; }
        .btn-danger:hover { background: #b91c1c; }
        .main-content { padding: 24px; max-width: 1200px; margin: 0 auto; }
        .card { background: #2d2d2d; border-radius: 12px; border: 1px solid #404040; margin-bottom: 20px; overflow: hidden; }
        .card-header { background: #353535; padding: 14px 20px; border-bottom: 1px solid #404040; display: flex; justify-content: space-between; align-items: center; }
        .card-header h2 { font-size: 1rem; font-weight: 600; color: #f97316; }
        .card-body { padding: 20px; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px; }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-group label { font-size: 0.85rem; color: #999; }
        .form-group input, .form-group select { padding: 12px 14px; border: 1px solid #404040; border-radius: 8px; background: #1a1a1a; color: #fff; font-size: 1rem; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #f97316; }
        .form-group input::placeholder { color: #666; }
        .item-row { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 12px; align-items: center; padding: 12px 0; border-bottom: 1px solid #353535; }
        .item-row:last-child { border-bottom: none; }
        .item-row input, .item-row select { padding: 10px 12px; border: 1px solid #404040; border-radius: 6px; background: #1a1a1a; color: #fff; font-size: 0.9rem; }
        .item-row input:focus, .item-row select:focus { outline: none; border-color: #f97316; }
        .item-row .cost { color: #16a34a; font-weight: 600; text-align: right; }
        .item-row .remove-btn { background: none; border: none; color: #666; cursor: pointer; padding: 8px; font-size: 1.2rem; }
        .item-row .remove-btn:hover { color: #dc2626; }
        .item-header { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 12px; padding: 0 0 10px 0; border-bottom: 1px solid #404040; margin-bottom: 10px; font-size: 0.8rem; color: #999; text-transform: uppercase; letter-spacing: 0.5px; }
        .item-header span:nth-child(4) { text-align: right; }
        .add-row-btn { display: flex; align-items: center; gap: 8px; padding: 12px; background: #353535; border: 1px dashed #525252; border-radius: 8px; color: #999; cursor: pointer; width: 100%; justify-content: center; margin-top: 12px; transition: all 0.2s; }
        .add-row-btn:hover { background: #404040; border-color: #f97316; color: #f97316; }
        .summary-card { background: linear-gradient(135deg, #2d2d2d 0%, #353535 100%); border: 2px solid #f97316; }
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .summary-left { display: flex; flex-direction: column; gap: 12px; }
        .summary-line { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #404040; }
        .summary-line.subtotal { font-weight: 600; color: #f97316; }
        .summary-line.total { font-size: 1.3rem; font-weight: 700; color: #16a34a; border-bottom: none; padding-top: 12px; border-top: 2px solid #f97316; }
        .summary-line .label { color: #999; }
        .summary-line .value { font-weight: 600; }
        .summary-right { display: flex; flex-direction: column; align-items: center; justify-content: center; background: #1a1a1a; border-radius: 12px; padding: 24px; }
        .price-per-sqft { text-align: center; }
        .price-per-sqft .amount { font-size: 3rem; font-weight: 700; color: #f97316; }
        .price-per-sqft .unit { font-size: 1rem; color: #999; }
        .action-bar { display: flex; gap: 12px; justify-content: flex-end; flex-wrap: wrap; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); z-index: 100; align-items: center; justify-content: center; padding: 20px; }
        .modal-overlay.show { display: flex; }
        .modal { background: #2d2d2d; border-radius: 16px; width: 100%; max-width: 600px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column; border: 1px solid #404040; }
        .modal-header { padding: 16px 20px; border-bottom: 1px solid #404040; display: flex; justify-content: space-between; align-items: center; background: #353535; }
        .modal-header h3 { font-size: 1.1rem; color: #f97316; }
        .modal-close { background: none; border: none; color: #999; font-size: 1.5rem; cursor: pointer; }
        .modal-close:hover { color: #fff; }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        .preview-box { background: #1a1a1a; border-radius: 8px; padding: 16px; font-family: 'Courier New', monospace; font-size: 0.85rem; line-height: 1.6; white-space: pre-wrap; color: #e5e5e5; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid #404040; display: flex; gap: 12px; justify-content: flex-end; background: #353535; }
        .toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: #16a34a; color: white; padding: 12px 24px; border-radius: 8px; font-weight: 600; opacity: 0; transition: opacity 0.3s; z-index: 200; }
        .toast.show { opacity: 1; }
        .tabs { display: flex; background: #2d2d2d; padding: 0 24px; gap: 4px; border-bottom: 1px solid #404040; }
        .tab { padding: 14px 24px; background: transparent; border: none; color: #999; font-size: 0.95rem; font-weight: 500; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s; }
        .tab:hover { color: #fff; }
        .tab.active { color: #f97316; border-bottom-color: #f97316; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .history-list { display: flex; flex-direction: column; gap: 12px; }
        .history-card { background: #2d2d2d; border: 1px solid #404040; border-radius: 12px; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; }
        .history-card:hover { border-color: #f97316; background: #353535; }
        .history-info { flex: 1; cursor: pointer; }
        .history-info h3 { font-size: 1rem; font-weight: 600; margin-bottom: 4px; color: #fff; }
        .history-info p { font-size: 0.85rem; color: #999; }
        .history-stats { text-align: right; margin-right: 16px; }
        .history-stats .total { font-size: 1.2rem; font-weight: 700; color: #16a34a; }
        .history-stats .sqft { font-size: 0.85rem; color: #f97316; }
        .history-actions { display: flex; gap: 8px; }
        .delete-btn { background: none; border: none; color: #666; cursor: pointer; padding: 8px; font-size: 1.3rem; border-radius: 6px; transition: all 0.2s; }
        .delete-btn:hover { color: #dc2626; background: rgba(220, 38, 38, 0.1); }
        .no-history { text-align: center; padding: 60px 20px; color: #666; }
        .no-history p { margin-bottom: 16px; }
        .quick-buttons { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 12px; }
        .quick-btn { flex: 1; min-width: 120px; padding: 16px 20px; background: #1a1a1a; border: 2px solid #404040; border-radius: 10px; color: #fff; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .quick-btn:hover { border-color: #f97316; background: #2d2d2d; color: #f97316; }
        .quick-btn:active { transform: scale(0.98); }
        .quick-note { font-size: 0.85rem; color: #666; text-align: center; }
        @media (max-width: 768px) {
            .header { padding: 12px 16px; }
            .main-content { padding: 16px; }
            .item-row, .item-header { grid-template-columns: 1fr; gap: 8px; }
            .item-header { display: none; }
            .item-row input, .item-row select { width: 100%; }
            .item-row .cost { text-align: left; }
            .summary-grid { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>üß± Spencer's Masonry - Bid Calculator</h1>
        <div class="header-controls">
            <a href="index.html" class="btn btn-back">‚Üê Back to Menu</a>
        </div>
    </header>

    <div class="tabs">
        <button class="tab active" onclick="switchTab('calculator')">Calculator</button>
        <button class="tab" onclick="switchTab('history')">Saved Bids</button>
    </div>

    <div class="main-content">
        <div class="tab-content active" id="calculatorTab">
            <div class="card">
                <div class="card-header"><h2>‚ö° Quick Start - Select Square Footage</h2></div>
                <div class="card-body">
                    <div class="quick-buttons">
                        <button class="quick-btn" onclick="autoPopulate(5000)">5,000 sq ft</button>
                        <button class="quick-btn" onclick="autoPopulate(6000)">6,000 sq ft</button>
                        <button class="quick-btn" onclick="autoPopulate(7000)">7,000 sq ft</button>
                        <button class="quick-btn" onclick="autoPopulate(8000)">8,000 sq ft</button>
                        <button class="quick-btn" onclick="autoPopulate(9000)">9,000 sq ft</button>
                        <button class="quick-btn" onclick="autoPopulate(10000)">10,000 sq ft</button>
                    </div>
                    <p class="quick-note">Click a button to auto-populate a ~$27/sq ft bid. You can adjust anything after.</p>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><h2>üìã Job Information</h2></div>
                <div class="card-body">
                    <div class="form-row">
                        <div class="form-group"><label>Job Name</label><input type="text" id="jobName" placeholder="e.g., KR1 Tent Slab" oninput="calculate()"></div>
                        <div class="form-group"><label>Client</label><input type="text" id="clientName" placeholder="e.g., John Smith" oninput="calculate()"></div>
                        <div class="form-group"><label>Square Footage</label><input type="number" id="squareFootage" placeholder="e.g., 7000" oninput="calculate()"></div>
                        <div class="form-group"><label>Avg Labor Rate ($/hr)</label><input type="number" id="laborRate" value="85" placeholder="85" oninput="updateLaborRate()"></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><h2>üë∑ Labor Tasks</h2></div>
                <div class="card-body">
                    <div class="item-header"><span>Task</span><span>Hours</span><span>Crew Size</span><span>Cost</span><span></span></div>
                    <div id="taskList"></div>
                    <button class="add-row-btn" onclick="addTask()">+ Add Task</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><h2>üöú Equipment</h2></div>
                <div class="card-body">
                    <div class="item-header"><span>Equipment</span><span>Hours</span><span>Rate/Hr</span><span>Cost</span><span></span></div>
                    <div id="equipmentList"></div>
                    <button class="add-row-btn" onclick="addEquipment()">+ Add Equipment</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><h2>üß± Materials</h2></div>
                <div class="card-body">
                    <div class="item-header"><span>Material</span><span>Quantity</span><span>Unit Price</span><span>Cost</span><span></span></div>
                    <div id="materialList"></div>
                    <button class="add-row-btn" onclick="addMaterial()">+ Add Material</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><h2>üìù Additional Costs</h2></div>
                <div class="card-body">
                    <div class="item-header"><span>Description</span><span></span><span></span><span>Cost</span><span></span></div>
                    <div id="additionalList"></div>
                    <button class="add-row-btn" onclick="addAdditional()">+ Add Cost</button>
                </div>
            </div>

            <div class="card summary-card">
                <div class="card-header"><h2>üí∞ Bid Summary</h2></div>
                <div class="card-body">
                    <div class="summary-grid">
                        <div class="summary-left">
                            <div class="summary-line"><span class="label">Labor</span><span class="value" id="sumLabor">$0</span></div>
                            <div class="summary-line"><span class="label">Equipment</span><span class="value" id="sumEquipment">$0</span></div>
                            <div class="summary-line"><span class="label">Materials</span><span class="value" id="sumMaterials">$0</span></div>
                            <div class="summary-line"><span class="label">Additional Costs</span><span class="value" id="sumAdditional">$0</span></div>
                            <div class="summary-line subtotal"><span class="label">Subtotal</span><span class="value" id="sumSubtotal">$0</span></div>
                            <div class="summary-line"><span class="label">Overhead (18%)</span><span class="value" id="sumOverhead">$0</span></div>
                            <div class="summary-line"><span class="label">Profit (10%)</span><span class="value" id="sumProfit">$0</span></div>
                            <div class="summary-line"><span class="label">GE Tax (4.712%)</span><span class="value" id="sumTax">$0</span></div>
                            <div class="summary-line total"><span class="label">TOTAL BID</span><span class="value" id="sumTotal">$0</span></div>
                        </div>
                        <div class="summary-right">
                            <div class="price-per-sqft">
                                <div class="amount" id="pricePerSqft">$0.00</div>
                                <div class="unit">per sq ft</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="action-bar">
                <button class="btn btn-secondary" onclick="clearAll()">üÜï New Bid</button>
                <button class="btn btn-primary" onclick="saveBid()">üíæ Save Bid</button>
                <button class="btn btn-success" onclick="generateBidSheet()">üìã Copy Bid Sheet</button>
            </div>
        </div>

        <div class="tab-content" id="historyTab">
            <h2 style="margin-bottom: 20px; color: #f97316;">Saved Bids</h2>
            <div class="history-list" id="bidHistoryList"></div>
        </div>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header"><h3>Bid Sheet</h3><button class="modal-close" onclick="closeModal()">&times;</button></div>
            <div class="modal-body"><div class="preview-box" id="previewBox"></div></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                <button class="btn btn-success" onclick="copyBidSheet()">üìã Copy to Clipboard</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">Copied!</div>

    <script>
        let avgHourlyRate = 85;
        const JSONBIN_BIN_ID = '697a7070d0ea881f408e6063';
        const JSONBIN_API_KEY = '\$2a\$10\$vgUvy.chZeKckQe2eTD36uOX/mfrhx8GKudyoZqZsjWkbtaam8/Nm';
        const STORAGE_KEY_BIDS = 'bids';
        
        function updateLaborRate() { avgHourlyRate = parseFloat(document.getElementById('laborRate').value) || 85; renderTasks(); calculate(); }

        const PRESET_TASKS = ['Setup','Form & Rebar','Grade','Dig Footings','Pour','Strip','Finish','Yard Load/Unload','Mobilization'];
        const PRESET_EQUIPMENT = [{name:'TL12 Skidsteer',rate:200},{name:'290 Excavator',rate:200},{name:'145 Excavator',rate:195},{name:'240 Excavator',rate:180},{name:'197 Excavator',rate:200},{name:'Concrete Pump',rate:900},{name:'Truck 450',rate:200},{name:'Truck 650',rate:900}];
        const PRESET_MATERIALS = [{name:'Concrete (per yard)',price:338},{name:'Gatorbar',price:50},{name:'Rebar #4 (per bar)',price:15},{name:'Rebar #6 (per bar)',price:35},{name:'Forms',price:100},{name:'Gravel (per ton)',price:75},{name:'Tie Wire',price:50},{name:'Cure',price:400},{name:'Pins',price:50}];

        let tasks = [], equipment = [], materials = [], additionalCosts = [];
        let taskIdCounter = 0, equipIdCounter = 0, matIdCounter = 0, addIdCounter = 0;
        let savedBids = [], currentBidId = null;

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            if (tab === 'calculator') { document.querySelector('.tab:nth-child(1)').classList.add('active'); document.getElementById('calculatorTab').classList.add('active'); }
            else { document.querySelector('.tab:nth-child(2)').classList.add('active'); document.getElementById('historyTab').classList.add('active'); renderHistory(); }
        }

        async function loadAllData() { try { const r = await fetch('https://api.jsonbin.io/v3/b/'+JSONBIN_BIN_ID+'/latest', {headers:{'X-Access-Key':JSONBIN_API_KEY}}); const d = await r.json(); return d.record || {}; } catch(e) { return {}; } }
        async function saveAllData(data) { try { const r = await fetch('https://api.jsonbin.io/v3/b/'+JSONBIN_BIN_ID, {method:'PUT',headers:{'Content-Type':'application/json','X-Access-Key':JSONBIN_API_KEY},body:JSON.stringify(data)}); return r.ok; } catch(e) { return false; } }
        async function loadBids() { const d = await loadAllData(); savedBids = d[STORAGE_KEY_BIDS] || []; }
        async function saveBidsToCloud() { const d = await loadAllData(); d[STORAGE_KEY_BIDS] = savedBids; return await saveAllData(d); }

        async function initApp() { await loadBids(); addTask('Setup'); addTask('Form & Rebar'); addTask('Pour'); addTask('Strip'); addEquipment(); addMaterial('Concrete (per yard)', 338); addMaterial('Rebar #4 (per bar)', 15); addMaterial('Forms', 100); }

        function addTask(presetName = '') { const id = taskIdCounter++; tasks.push({id, name: presetName, hours: 0, crewSize: 1}); renderTasks(); }
        function removeTask(id) { tasks = tasks.filter(t => t.id !== id); renderTasks(); calculate(); }
        function renderTasks() {
            const c = document.getElementById('taskList');
            c.innerHTML = tasks.map(t => '<div class="item-row"><select onchange="updateTask('+t.id+', \'name\', this.value)"><option value="">Select task...</option>'+PRESET_TASKS.map(p => '<option value="'+p+'" '+(t.name===p?'selected':'')+'>'+p+'</option>').join('')+'<option value="custom" '+(t.name && !PRESET_TASKS.includes(t.name)?'selected':'')+'>Custom...</option></select><input type="number" placeholder="Hours" value="'+(t.hours||'')+'" onchange="updateTask('+t.id+', \'hours\', this.value)"><input type="number" placeholder="Crew" value="'+(t.crewSize||'')+'" onchange="updateTask('+t.id+', \'crewSize\', this.value)"><span class="cost">$'+((t.hours||0)*(t.crewSize||1)*avgHourlyRate).toLocaleString()+'</span><button class="remove-btn" onclick="removeTask('+t.id+')">√ó</button></div>').join('');
        }
        function updateTask(id, field, value) { const t = tasks.find(x => x.id === id); if(t) { t[field] = field === 'name' ? value : parseFloat(value) || 0; renderTasks(); calculate(); } }

        function addEquipment(presetName = '', presetRate = 0) { const id = equipIdCounter++; equipment.push({id, name: presetName, hours: 0, rate: presetRate}); renderEquipment(); }
        function removeEquipment(id) { equipment = equipment.filter(e => e.id !== id); renderEquipment(); calculate(); }
        function renderEquipment() {
            const c = document.getElementById('equipmentList');
            c.innerHTML = equipment.map(e => '<div class="item-row"><select onchange="updateEquipmentFromPreset('+e.id+', this.value)"><option value="">Select equipment...</option>'+PRESET_EQUIPMENT.map(p => '<option value="'+p.name+'|'+p.rate+'" '+(e.name===p.name?'selected':'')+'>'+p.name+'</option>').join('')+'</select><input type="number" placeholder="Hours" value="'+(e.hours||'')+'" onchange="updateEquipment('+e.id+', \'hours\', this.value)"><input type="number" placeholder="$/hr" value="'+(e.rate||'')+'" onchange="updateEquipment('+e.id+', \'rate\', this.value)"><span class="cost">$'+((e.hours||0)*(e.rate||0)).toLocaleString()+'</span><button class="remove-btn" onclick="removeEquipment('+e.id+')">√ó</button></div>').join('');
        }
        function updateEquipmentFromPreset(id, value) { const [name, rate] = value.split('|'); const e = equipment.find(x => x.id === id); if(e) { e.name = name; e.rate = parseFloat(rate) || 0; renderEquipment(); calculate(); } }
        function updateEquipment(id, field, value) { const e = equipment.find(x => x.id === id); if(e) { e[field] = field === 'name' ? value : parseFloat(value) || 0; renderEquipment(); calculate(); } }

        function addMaterial(presetName = '', presetPrice = 0) { const id = matIdCounter++; materials.push({id, name: presetName, quantity: 0, price: presetPrice}); renderMaterials(); }
        function removeMaterial(id) { materials = materials.filter(m => m.id !== id); renderMaterials(); calculate(); }
        function renderMaterials() {
            const c = document.getElementById('materialList');
            c.innerHTML = materials.map(m => '<div class="item-row"><select onchange="updateMaterialFromPreset('+m.id+', this.value)"><option value="">Select material...</option>'+PRESET_MATERIALS.map(p => '<option value="'+p.name+'|'+p.price+'" '+(m.name===p.name?'selected':'')+'>'+p.name+'</option>').join('')+'<option value="custom|0">Custom...</option></select><input type="number" placeholder="Qty" value="'+(m.quantity||'')+'" onchange="updateMaterial('+m.id+', \'quantity\', this.value)"><input type="number" placeholder="$" value="'+(m.price||'')+'" onchange="updateMaterial('+m.id+', \'price\', this.value)"><span class="cost">$'+((m.quantity||0)*(m.price||0)).toLocaleString()+'</span><button class="remove-btn" onclick="removeMaterial('+m.id+')">√ó</button></div>').join('');
        }
        function updateMaterialFromPreset(id, value) { const [name, price] = value.split('|'); const m = materials.find(x => x.id === id); if(m) { m.name = name === 'custom' ? '' : name; m.price = parseFloat(price) || 0; renderMaterials(); calculate(); } }
        function updateMaterial(id, field, value) { const m = materials.find(x => x.id === id); if(m) { m[field] = field === 'name' ? value : parseFloat(value) || 0; renderMaterials(); calculate(); } }

        function addAdditional() { const id = addIdCounter++; additionalCosts.push({id, description: '', cost: 0}); renderAdditional(); }
        function removeAdditional(id) { additionalCosts = additionalCosts.filter(a => a.id !== id); renderAdditional(); calculate(); }
        function renderAdditional() {
            const c = document.getElementById('additionalList');
            c.innerHTML = additionalCosts.map(a => '<div class="item-row"><input type="text" placeholder="Description" value="'+a.description+'" onchange="updateAdditional('+a.id+', \'description\', this.value)"><span></span><span></span><input type="number" placeholder="$" value="'+(a.cost||'')+'" onchange="updateAdditional('+a.id+', \'cost\', this.value)" style="text-align: right;"><button class="remove-btn" onclick="removeAdditional('+a.id+')">√ó</button></div>').join('');
        }
        function updateAdditional(id, field, value) { const a = additionalCosts.find(x => x.id === id); if(a) { a[field] = field === 'description' ? value : parseFloat(value) || 0; calculate(); } }

        function calculate() {
            const laborTotal = tasks.reduce((s, t) => s + ((t.hours||0) * (t.crewSize||1) * avgHourlyRate), 0);
            const equipTotal = equipment.reduce((s, e) => s + ((e.hours||0) * (e.rate||0)), 0);
            const matTotal = materials.reduce((s, m) => s + ((m.quantity||0) * (m.price||0)), 0);
            const addTotal = additionalCosts.reduce((s, a) => s + (a.cost||0), 0);
            const subtotal = laborTotal + equipTotal + matTotal + addTotal;
            const overhead = subtotal * 0.18;
            const subtotalWithOH = subtotal + overhead;
            const profit = subtotalWithOH * 0.10;
            const subtotalWithProfit = subtotalWithOH + profit;
            const geTax = subtotalWithProfit * 0.04712;
            const total = subtotalWithProfit + geTax;
            const sqft = parseFloat(document.getElementById('squareFootage').value) || 0;
            const pricePerSqft = sqft > 0 ? total / sqft : 0;
            document.getElementById('sumLabor').textContent = '$' + laborTotal.toLocaleString();
            document.getElementById('sumEquipment').textContent = '$' + equipTotal.toLocaleString();
            document.getElementById('sumMaterials').textContent = '$' + matTotal.toLocaleString();
            document.getElementById('sumAdditional').textContent = '$' + addTotal.toLocaleString();
            document.getElementById('sumSubtotal').textContent = '$' + subtotal.toLocaleString();
            document.getElementById('sumOverhead').textContent = '$' + overhead.toLocaleString(undefined, {maximumFractionDigits: 2});
            document.getElementById('sumProfit').textContent = '$' + profit.toLocaleString(undefined, {maximumFractionDigits: 2});
            document.getElementById('sumTax').textContent = '$' + geTax.toLocaleString(undefined, {maximumFractionDigits: 2});
            document.getElementById('sumTotal').textContent = '$' + total.toLocaleString(undefined, {maximumFractionDigits: 2});
            document.getElementById('pricePerSqft').textContent = '$' + pricePerSqft.toFixed(2);
        }

        function autoPopulate(sqft) {
            const targetTotal = sqft * 27;
            const subtotal = targetTotal / 1.3591;
            const laborBudget = subtotal * 0.33, equipBudget = subtotal * 0.05, matBudget = subtotal * 0.55, addBudget = subtotal * 0.07;
            tasks = []; equipment = []; materials = []; additionalCosts = [];
            taskIdCounter = 0; equipIdCounter = 0; matIdCounter = 0; addIdCounter = 0;
            document.getElementById('squareFootage').value = sqft;
            const scale = sqft / 7000;
            const totalLaborHours = laborBudget / avgHourlyRate;
            [{name:'Setup',pct:0.08},{name:'Form & Rebar',pct:0.30},{name:'Grade',pct:0.12},{name:'Dig Footings',pct:0.08},{name:'Pour',pct:0.22},{name:'Strip',pct:0.10},{name:'Finish',pct:0.05},{name:'Yard Load/Unload',pct:0.05}].forEach(t => { const id = taskIdCounter++; tasks.push({id, name: t.name, hours: Math.round(totalLaborHours * t.pct / 4), crewSize: 4}); });
            [{name:'290 Excavator',rate:200,pct:0.40},{name:'TL12 Skidsteer',rate:200,pct:0.35},{name:'Concrete Pump',rate:900,pct:0.25}].forEach(e => { const id = equipIdCounter++; equipment.push({id, name: e.name, hours: Math.round(equipBudget * e.pct / e.rate), rate: e.rate}); });
            const concreteYards = Math.ceil(sqft / 80), concreteCost = concreteYards * 338, remainingMatBudget = matBudget - concreteCost;
            [{name:'Concrete (per yard)',qty:concreteYards,price:338},{name:'Rebar #4 (per bar)',qty:Math.round(sqft/25),price:15},{name:'Rebar #6 (per bar)',qty:Math.round(sqft/50),price:35},{name:'Gatorbar',qty:Math.round(remainingMatBudget*0.15/50),price:50},{name:'Forms',qty:Math.round(remainingMatBudget*0.10/100),price:100},{name:'Gravel (per ton)',qty:Math.round(remainingMatBudget*0.25/75),price:75},{name:'Cure',qty:Math.ceil(scale),price:400},{name:'Pins',qty:Math.round(remainingMatBudget*0.05/50),price:50}].forEach(m => { const id = matIdCounter++; materials.push({id, name: m.name, quantity: m.qty, price: m.price}); });
            [{description:'Total Station',cost:Math.round(addBudget*0.25)},{description:'Pour Crew (sub)',cost:Math.round(addBudget*0.35)},{description:'Mobilization',cost:Math.round(addBudget*0.20)},{description:'Misc/Contingency',cost:Math.round(addBudget*0.20)}].forEach(a => { const id = addIdCounter++; additionalCosts.push({id, description: a.description, cost: a.cost}); });
            renderTasks(); renderEquipment(); renderMaterials(); renderAdditional(); calculate();
            showToast('Auto-populated for ' + sqft.toLocaleString() + ' sq ft @ ~$27/sq ft');
        }

        function clearAll() {
            if (!confirm('Clear all and start a new bid?')) return;
            currentBidId = null;
            document.getElementById('jobName').value = '';
            document.getElementById('clientName').value = '';
            document.getElementById('squareFootage').value = '';
            tasks = []; equipment = []; materials = []; additionalCosts = [];
            taskIdCounter = 0; equipIdCounter = 0; matIdCounter = 0; addIdCounter = 0;
            renderTasks(); renderEquipment(); renderMaterials(); renderAdditional(); calculate();
            addTask('Setup'); addTask('Form & Rebar'); addTask('Pour'); addTask('Strip');
            addEquipment(); addMaterial('Concrete (per yard)', 338); addMaterial('Rebar #4 (per bar)', 15); addMaterial('Forms', 100);
        }

        async function saveBid() {
            const jobName = document.getElementById('jobName').value || 'Untitled Job';
            const clientName = document.getElementById('clientName').value || '';
            const sqft = document.getElementById('squareFootage').value || 0;
            const laborRate = document.getElementById('laborRate').value || 85;
            const total = document.getElementById('sumTotal').textContent;
            const pricePerSqft = document.getElementById('pricePerSqft').textContent;
            const bid = { id: currentBidId || Date.now(), jobName, clientName, sqft: parseInt(sqft), laborRate: parseFloat(laborRate), total, pricePerSqft, tasks: [...tasks], equipment: [...equipment], materials: [...materials], additionalCosts: [...additionalCosts], createdAt: currentBidId ? (savedBids.find(b => b.id === currentBidId)?.createdAt || new Date().toISOString()) : new Date().toISOString(), updatedAt: new Date().toISOString() };
            if (currentBidId) { const i = savedBids.findIndex(b => b.id === currentBidId); if (i !== -1) savedBids[i] = bid; }
            else { savedBids.unshift(bid); currentBidId = bid.id; }
            const success = await saveBidsToCloud();
            showToast(success ? 'Bid saved!' : 'Save failed - try again');
        }

        function renderHistory() {
            const c = document.getElementById('bidHistoryList');
            if (savedBids.length === 0) { c.innerHTML = '<div class="no-history"><p>No saved bids yet.</p><button class="btn btn-primary" onclick="switchTab(\'calculator\')">Create Your First Bid</button></div>'; return; }
            c.innerHTML = savedBids.map(b => { const date = new Date(b.createdAt).toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'}); return '<div class="history-card"><div class="history-info" onclick="loadBid('+b.id+')"><h3>'+b.jobName+'</h3><p>'+(b.clientName ? b.clientName+' ‚Ä¢ ' : '')+date+'</p></div><div class="history-stats"><div class="total">'+b.total+'</div><div class="sqft">'+(b.sqft ? b.sqft.toLocaleString()+' sq ft ‚Ä¢ ' : '')+b.pricePerSqft+'/sf</div></div><div class="history-actions"><button class="delete-btn" onclick="deleteBid('+b.id+')" title="Delete bid">üóëÔ∏è</button></div></div>'; }).join('');
        }

        function loadBid(id) {
            const b = savedBids.find(x => x.id === id); if (!b) return;
            currentBidId = id;
            document.getElementById('jobName').value = b.jobName || '';
            document.getElementById('clientName').value = b.clientName || '';
            document.getElementById('squareFootage').value = b.sqft || '';
            document.getElementById('laborRate').value = b.laborRate || 85;
            avgHourlyRate = b.laborRate || 85;
            tasks = b.tasks || []; equipment = b.equipment || []; materials = b.materials || []; additionalCosts = b.additionalCosts || [];
            taskIdCounter = Math.max(...tasks.map(t => t.id), 0) + 1;
            equipIdCounter = Math.max(...equipment.map(e => e.id), 0) + 1;
            matIdCounter = Math.max(...materials.map(m => m.id), 0) + 1;
            addIdCounter = Math.max(...additionalCosts.map(a => a.id), 0) + 1;
            renderTasks(); renderEquipment(); renderMaterials(); renderAdditional(); calculate();
            switchTab('calculator'); showToast('Bid loaded!');
        }

        async function deleteBid(id) {
            if (!confirm('Delete this bid? This cannot be undone.')) return;
            savedBids = savedBids.filter(b => b.id !== id);
            if (currentBidId === id) currentBidId = null;
            const success = await saveBidsToCloud();
            if (success) { renderHistory(); showToast('Bid deleted'); } else showToast('Delete failed - try again');
        }

        function generateBidSheet() {
            const jobName = document.getElementById('jobName').value || 'Untitled Job';
            const clientName = document.getElementById('clientName').value || 'N/A';
            const sqft = document.getElementById('squareFootage').value || '0';
            let sheet = "SPENCER'S MASONRY\nPO BOX 267\nKapaa, HI 96746\n808-482-0673\n" + '‚ïê'.repeat(45) + "\n\nBID ESTIMATE\n" + '‚îÄ'.repeat(45) + "\nJob: " + jobName + "\nClient: " + clientName + "\nSquare Footage: " + parseInt(sqft).toLocaleString() + " sq ft\n\n";
            const laborItems = tasks.filter(t => t.hours > 0);
            if (laborItems.length > 0) { sheet += "LABOR\n"; laborItems.forEach(t => { sheet += "  " + t.name + ": " + t.hours + " hrs √ó " + t.crewSize + " crew = $" + ((t.hours||0)*(t.crewSize||1)*avgHourlyRate).toLocaleString() + "\n"; }); sheet += "\n"; }
            const equipItems = equipment.filter(e => e.hours > 0);
            if (equipItems.length > 0) { sheet += "EQUIPMENT\n"; equipItems.forEach(e => { sheet += "  " + e.name + ": " + e.hours + " hrs @ $" + e.rate + "/hr = $" + ((e.hours||0)*(e.rate||0)).toLocaleString() + "\n"; }); sheet += "\n"; }
            const matItems = materials.filter(m => m.quantity > 0);
            if (matItems.length > 0) { sheet += "MATERIALS\n"; matItems.forEach(m => { sheet += "  " + m.name + ": " + m.quantity + " √ó $" + m.price + " = $" + ((m.quantity||0)*(m.price||0)).toLocaleString() + "\n"; }); sheet += "\n"; }
            const addItems = additionalCosts.filter(a => a.cost > 0);
            if (addItems.length > 0) { sheet += "ADDITIONAL COSTS\n"; addItems.forEach(a => { sheet += "  " + a.description + ": $" + a.cost.toLocaleString() + "\n"; }); sheet += "\n"; }
            sheet += '‚ïê'.repeat(45) + "\nSUMMARY\n  Labor:           " + document.getElementById('sumLabor').textContent + "\n  Equipment:       " + document.getElementById('sumEquipment').textContent + "\n  Materials:       " + document.getElementById('sumMaterials').textContent + "\n  Additional:      " + document.getElementById('sumAdditional').textContent + "\n  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n  Subtotal:        " + document.getElementById('sumSubtotal').textContent + "\n  Overhead (18%):  " + document.getElementById('sumOverhead').textContent + "\n  Profit (10%):    " + document.getElementById('sumProfit').textContent + "\n  GE Tax (4.712%): " + document.getElementById('sumTax').textContent + "\n  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n  TOTAL BID:       " + document.getElementById('sumTotal').textContent + "\n\n  Price per sq ft: " + document.getElementById('pricePerSqft').textContent + "\n" + '‚ïê'.repeat(45);
            document.getElementById('previewBox').textContent = sheet;
            document.getElementById('modalOverlay').classList.add('show');
        }

        function closeModal() { document.getElementById('modalOverlay').classList.remove('show'); }
        function copyBidSheet() { navigator.clipboard.writeText(document.getElementById('previewBox').textContent).then(() => { showToast('Copied to clipboard!'); closeModal(); }); }
        function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }
        document.getElementById('modalOverlay').addEventListener('click', function(e) { if (e.target === this) closeModal(); });
        initApp();
    </script>
</body>
</html>
