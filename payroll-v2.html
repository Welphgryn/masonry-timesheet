<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spencer's Masonry - Payroll</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            min-height: 100vh;
            color: #ffffff;
        }

        .header {
            background: #f97316;
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header h1 {
            font-size: 1.1rem;
            color: white;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn-back {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        .btn-back:hover { background: rgba(255,255,255,0.3); }

        .btn-primary { background: #f97316; color: white; }
        .btn-primary:hover { background: #ea580c; }

        .btn-secondary { background: #404040; color: #fff; }
        .btn-secondary:hover { background: #525252; }

        .btn-success { background: #16a34a; color: white; }
        .btn-success:hover { background: #15803d; }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        .tabs {
            display: flex;
            background: #2d2d2d;
            padding: 0 24px;
            gap: 4px;
            border-bottom: 1px solid #404040;
        }

        .tab {
            padding: 14px 24px;
            background: transparent;
            border: none;
            color: #999;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .tab:hover { color: #fff; }
        .tab.active { color: #f97316; border-bottom-color: #f97316; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .main-content {
            padding: 24px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .week-selector {
            background: #2d2d2d;
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            border: 1px solid #404040;
        }

        .week-nav {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .week-nav button {
            background: #404040;
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .week-nav button:hover { background: #f97316; }

        .week-display { text-align: center; }
        .week-display .period { font-size: 1.1rem; font-weight: 600; color: #f97316; }
        .week-display .dates { font-size: 0.85rem; color: #999; margin-top: 2px; }

        .save-status { font-size: 0.85rem; color: #999; display: flex; align-items: center; gap: 6px; }
        .save-status.saving { color: #f97316; }
        .save-status.saved { color: #16a34a; }

        .day-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .day-tab {
            padding: 10px 16px;
            background: #2d2d2d;
            border: 1px solid #404040;
            border-radius: 8px;
            color: #999;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .day-tab:hover { border-color: #f97316; color: #fff; }
        .day-tab.active { background: #f97316; border-color: #f97316; color: white; }
        .day-tab .day-name { font-weight: 600; }
        .day-tab .day-date { font-size: 0.75rem; opacity: 0.8; }

        .summary-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: #2d2d2d;
            padding: 14px 18px;
            border-radius: 10px;
            border: 1px solid #404040;
        }

        .summary-card .label { font-size: 0.75rem; color: #999; text-transform: uppercase; margin-bottom: 4px; }
        .summary-card .value { font-size: 1.3rem; font-weight: 700; }
        .summary-card .value.orange { color: #f97316; }
        .summary-card .value.green { color: #16a34a; }
        .summary-card .value.yellow { color: #eab308; }

        /* Employee Weekly Summary Section */
        .employee-summary-section {
            background: #2d2d2d;
            border-radius: 12px;
            border: 1px solid #404040;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .employee-summary-header {
            padding: 14px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            background: #353535;
            user-select: none;
        }

        .employee-summary-header:hover {
            background: #3d3d3d;
        }

        .employee-summary-header h3 {
            font-size: 0.95rem;
            font-weight: 600;
            color: #f97316;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .employee-summary-header .toggle-icon {
            transition: transform 0.2s;
        }

        .employee-summary-header.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .employee-summary-content {
            padding: 16px 20px;
            display: block;
        }

        .employee-summary-content.hidden {
            display: none;
        }

        .employee-summary-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .employee-summary-list {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 16px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.8;
            white-space: pre-wrap;
            color: #e5e5e5;
            max-height: 300px;
            overflow-y: auto;
        }

        .employee-summary-list .summary-title {
            color: #f97316;
            font-weight: bold;
            margin-bottom: 8px;
            display: block;
        }

        .employee-summary-list .employee-line {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
        }

        .employee-summary-list .employee-line:hover {
            background: #2d2d2d;
        }

        .employee-summary-list .employee-name {
            color: #e5e5e5;
        }

        .employee-summary-list .employee-hours {
            color: #f97316;
            font-weight: 600;
        }

        .employee-summary-list .total-line {
            border-top: 1px solid #404040;
            margin-top: 8px;
            padding-top: 8px;
            font-weight: bold;
        }

        .timesheet-container {
            background: #2d2d2d;
            border-radius: 12px;
            border: 1px solid #404040;
            overflow: hidden;
        }

        .timesheet-header {
            padding: 14px 20px;
            border-bottom: 1px solid #404040;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            background: #353535;
        }

        .timesheet-header h2 { font-size: 1rem; font-weight: 600; color: #f97316; }

        .legend { display: flex; gap: 16px; font-size: 0.8rem; color: #999; }
        .legend span { display: flex; align-items: center; gap: 6px; }
        .legend-dot { width: 10px; height: 10px; border-radius: 50%; }
        .legend-dot.direct { background: #16a34a; }
        .legend-dot.indirect { background: #eab308; }

        .timesheet-scroll { overflow-x: auto; }

        .timesheet-grid {
            display: grid;
            min-width: 850px;
        }

        .grid-header {
            background: #404040;
            padding: 10px 6px;
            text-align: center;
            font-weight: 600;
            font-size: 0.8rem;
            border-bottom: 1px solid #525252;
        }

        .grid-header.job-col { text-align: left; padding-left: 14px; }
        .grid-header .rate { font-size: 0.65rem; color: #999; font-weight: 400; display: block; margin-top: 2px; }
        .grid-header .rate.hidden { display: none; }

        .grid-row { display: contents; }
        .grid-row:hover .grid-cell { background: #353535; }

        .grid-cell {
            padding: 6px;
            border-bottom: 1px solid #404040;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .grid-cell.job-cell { justify-content: flex-start; padding-left: 14px; font-weight: 500; font-size: 0.85rem; }
        .grid-cell.job-cell.indirect { color: #eab308; }
        .grid-cell.job-cell.direct { color: #16a34a; }

        /* Clickable job link */
        .job-link {
            color: inherit;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .job-link:hover {
            text-decoration: underline;
            opacity: 0.8;
        }

        .job-link.direct:hover { color: #4ade80; }

        .hour-input {
            width: 100%;
            max-width: 46px;
            padding: 8px 2px;
            border: 1px solid #404040;
            border-radius: 6px;
            background: #1a1a1a;
            color: #fff;
            font-size: 0.9rem;
            text-align: center;
        }

        .hour-input:focus { outline: none; border-color: #f97316; background: #2d2d2d; }
        .hour-input::placeholder { color: #525252; }

        .totals-row .grid-cell { background: #404040; font-weight: 600; border-bottom: none; }
        .totals-row .total-value { color: #f97316; }

        .action-bar {
            padding: 14px 20px;
            border-top: 1px solid #404040;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            background: #353535;
        }

        .action-buttons { display: flex; gap: 10px; }

        .history-list { display: flex; flex-direction: column; gap: 12px; }

        .history-card {
            background: #2d2d2d;
            border: 1px solid #404040;
            border-radius: 12px;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .history-card:hover { border-color: #f97316; background: #353535; }
        .history-card.current { border-color: #f97316; background: rgba(249, 115, 22, 0.1); }

        .history-info h3 { font-size: 1rem; font-weight: 600; margin-bottom: 4px; }
        .history-info p { font-size: 0.85rem; color: #999; }

        .history-stats { text-align: right; }
        .history-stats .hours { font-size: 1.2rem; font-weight: 700; color: #f97316; }
        .history-stats .cost { font-size: 0.85rem; color: #999; }

        .no-history { text-align: center; padding: 40px; color: #666; }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 100;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.show { display: flex; }

        .modal {
            background: #2d2d2d;
            border-radius: 16px;
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid #404040;
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #404040;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #353535;
        }

        .modal-header h3 { font-size: 1.1rem; color: #f97316; }
        .modal-close { background: none; border: none; color: #999; font-size: 1.5rem; cursor: pointer; }

        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }

        .preview-box {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 16px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
            white-space: pre-wrap;
            color: #e5e5e5;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid #404040;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            background: #353535;
        }

        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: #16a34a;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 200;
        }

        .toast.show { opacity: 1; }

        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 300;
        }

        .loading-overlay.hidden { display: none; }

        .loading-text {
            color: #f97316;
            font-size: 1.2rem;
        }

        .no-data-message {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .no-data-message h3 {
            color: #999;
            margin-bottom: 10px;
        }

        .no-data-message a {
            color: #f97316;
            text-decoration: none;
        }

        .no-data-message a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .header { padding: 12px 16px; }
            .main-content { padding: 16px; }
            .summary-bar { grid-template-columns: repeat(2, 1fr); }
            .week-selector { flex-direction: column; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-text">Loading...</div>
    </div>

    <header class="header">
        <div class="header-left">
            <a href="index.html" class="btn btn-back">‚Üê Menu</a>
            <h1>‚è±Ô∏è Payroll</h1>
            <button class="btn btn-secondary" id="toggleRatesBtn" onclick="toggleRates()" style="padding: 6px 12px; font-size: 0.8rem;">üëÅÔ∏è Hide Rates</button>
        </div>
        <div class="save-status" id="saveStatus">
            <span>‚óè</span> All changes saved
        </div>
    </header>

    <div class="tabs">
        <button class="tab active" onclick="switchTab('timesheet')">Timesheet</button>
        <button class="tab" onclick="switchTab('history')">History</button>
    </div>

    <div class="main-content">
        <div class="tab-content active" id="timesheetTab">
            <div class="week-selector">
                <div class="week-nav">
                    <button onclick="prevWeek()">‚Üê</button>
                    <div class="week-display">
                        <div class="period" id="weekPeriod">Week of Jan 24 - Jan 30</div>
                        <div class="dates" id="weekYear">2026</div>
                    </div>
                    <button onclick="nextWeek()">‚Üí</button>
                </div>
            </div>

            <div class="day-tabs" id="dayTabs"></div>

            <div class="summary-bar">
                <div class="summary-card">
                    <div class="label">Day Hours</div>
                    <div class="value orange" id="dayHours">0</div>
                </div>
                <div class="summary-card">
                    <div class="label">Direct Labor</div>
                    <div class="value green" id="directLabor">$0</div>
                </div>
                <div class="summary-card">
                    <div class="label">Indirect Labor</div>
                    <div class="value yellow" id="indirectLabor">$0</div>
                </div>
                <div class="summary-card">
                    <div class="label">Week Total</div>
                    <div class="value" id="weekTotal">$0</div>
                </div>
            </div>

            <!-- Employee Weekly Hours Summary -->
            <div class="employee-summary-section">
                <div class="employee-summary-header" onclick="toggleEmployeeSummary()">
                    <h3><span class="toggle-icon">‚ñº</span> Employee Weekly Hours</h3>
                    <span style="color: #999; font-size: 0.8rem;" id="summaryTotalHours">0 total hrs</span>
                </div>
                <div class="employee-summary-content" id="employeeSummaryContent">
                    <div class="employee-summary-actions">
                        <button class="btn btn-secondary btn-sm" onclick="copyEmployeeSummary(event)">üìã Copy</button>
                        <button class="btn btn-secondary btn-sm" onclick="downloadEmployeeSummary(event)">‚¨áÔ∏è Download</button>
                    </div>
                    <div class="employee-summary-list" id="employeeSummaryList">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <div class="timesheet-container">
                <div class="timesheet-header">
                    <h2 id="selectedDayDisplay">Friday, January 24, 2026</h2>
                    <div class="legend">
                        <span><div class="legend-dot indirect"></div> Indirect</span>
                        <span><div class="legend-dot direct"></div> Direct</span>
                    </div>
                </div>
                <div class="timesheet-scroll">
                    <div class="timesheet-grid" id="timesheetGrid"></div>
                </div>
                <div class="action-bar">
                    <span style="color: #999; font-size: 0.85rem;">Tab to move ‚Ä¢ Auto-saves</span>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="clearDay()">Clear Day</button>
                        <button class="btn btn-primary" onclick="generateReport()">üìã Copy Report</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="historyTab">
            <h2 style="margin-bottom: 20px; color: #f97316;">Payroll History</h2>
            <div class="history-list" id="historyList"></div>
        </div>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Weekly Payroll Report</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="preview-box" id="previewBox"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                <button class="btn btn-success" onclick="copyReport()">üìã Copy</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">Copied!</div>

    <script>
        // Config
        const JSONBIN_BIN_ID = '697a7070d0ea881f408e6063';
        const JSONBIN_API_KEY = '$2a$10$vgUvy.chZeKckQe2eTD36uOX/mfrhx8GKudyoZqZsjWkbtaam8/Nm';

        // Dynamic workers list - populated from allData.employees
        let workers = [];

        // Permanent indirect job sites (always shown)
        const permanentJobSites = [
            { name: 'Baseyard', type: 'indirect', id: null },
            { name: 'Office', type: 'indirect', id: null }
        ];

        // Will be populated from JSONbin
        let jobSites = [];
        let allData = {};
        let currentWeekStart = null;
        let selectedDayIndex = 0;
        let saveTimeout = null;
        let showRates = true;
        let employeeSummaryCollapsed = false;

        // ============================================
        // SEED DATA - Initial employees and jobs
        // ============================================
        const seedEmployees = {
            'jordan': { id: 'jordan', name: 'Jordan', rate: 120, status: 'active', sortOrder: 1, created: new Date().toISOString(), modified: new Date().toISOString() },
            'kamalei': { id: 'kamalei', name: 'Kamalei', rate: 100, status: 'active', sortOrder: 2, created: new Date().toISOString(), modified: new Date().toISOString() },
            'dave': { id: 'dave', name: 'Dave', rate: 114, status: 'active', sortOrder: 3, created: new Date().toISOString(), modified: new Date().toISOString() },
            'joe': { id: 'joe', name: 'Joe', rate: 114, status: 'active', sortOrder: 4, created: new Date().toISOString(), modified: new Date().toISOString() },
            'ian': { id: 'ian', name: 'Ian', rate: 100, status: 'active', sortOrder: 5, created: new Date().toISOString(), modified: new Date().toISOString() },
            'ray': { id: 'ray', name: 'Ray', rate: 100, status: 'active', sortOrder: 6, created: new Date().toISOString(), modified: new Date().toISOString() },
            'jestin': { id: 'jestin', name: 'Jestin', rate: 63, status: 'active', sortOrder: 7, created: new Date().toISOString(), modified: new Date().toISOString() },
            'duke': { id: 'duke', name: 'Duke', rate: 58, status: 'active', sortOrder: 8, created: new Date().toISOString(), modified: new Date().toISOString() },
            'keahi': { id: 'keahi', name: 'Keahi', rate: 52, status: 'active', sortOrder: 9, created: new Date().toISOString(), modified: new Date().toISOString() },
            'ruben': { id: 'ruben', name: 'Ruben', rate: 52, status: 'active', sortOrder: 10, created: new Date().toISOString(), modified: new Date().toISOString() },
            'beau': { id: 'beau', name: 'Beau', rate: 87.5, status: 'active', sortOrder: 11, created: new Date().toISOString(), modified: new Date().toISOString() },
            'seth': { id: 'seth', name: 'Seth', rate: 40, status: 'active', sortOrder: 12, created: new Date().toISOString(), modified: new Date().toISOString() },
            'kawika': { id: 'kawika', name: 'Kawika', rate: 35, status: 'active', sortOrder: 13, created: new Date().toISOString(), modified: new Date().toISOString() }
        };

        const seedJobs = {
            'asphalt-plant': { id: 'asphalt-plant', name: 'Asphalt Plant', payrollName: 'Asphalt Plant', status: 'active', jobType: 'hourly', created: new Date().toISOString(), modified: new Date().toISOString() },
            'airport-job': { id: 'airport-job', name: 'Airport Job', payrollName: 'Airport Job', status: 'active', jobType: 'hourly', created: new Date().toISOString(), modified: new Date().toISOString() },
            'jays-driveway': { id: 'jays-driveway', name: 'Jays Driveway', payrollName: 'Jays Driveway', status: 'active', jobType: 'hourly', created: new Date().toISOString(), modified: new Date().toISOString() },
            'schow': { id: 'schow', name: 'Schow', payrollName: 'Schow', status: 'active', jobType: 'hourly', created: new Date().toISOString(), modified: new Date().toISOString() },
            'braun': { id: 'braun', name: 'Braun', payrollName: 'Braun', status: 'active', jobType: 'hourly', created: new Date().toISOString(), modified: new Date().toISOString() },
            'punua': { id: 'punua', name: 'Punua', payrollName: 'Punua', status: 'active', jobType: 'hourly', created: new Date().toISOString(), modified: new Date().toISOString() },
            'mcphearson': { id: 'mcphearson', name: 'McPhearson', payrollName: 'McPhearson', status: 'active', jobType: 'hourly', created: new Date().toISOString(), modified: new Date().toISOString() },
            'dillon': { id: 'dillon', name: 'Dillon', payrollName: 'Dillon', status: 'active', jobType: 'hourly', created: new Date().toISOString(), modified: new Date().toISOString() },
            'erickson': { id: 'erickson', name: 'Erickson', payrollName: 'Erickson', status: 'active', jobType: 'hourly', created: new Date().toISOString(), modified: new Date().toISOString() }
        };

        // Check if we need to seed data
        async function checkAndSeedData() {
            let needsSave = false;

            // Seed employees if empty or doesn't exist
            if (!allData.employees || Object.keys(allData.employees).length === 0) {
                console.log('Seeding employees...');
                allData.employees = seedEmployees;
                needsSave = true;
            }

            // Seed jobs if empty or only has test data
            if (!allData.jobs || Object.keys(allData.jobs).length === 0 || 
                (Object.keys(allData.jobs).length === 1 && allData.jobs['test2'])) {
                console.log('Seeding jobs...');
                allData.jobs = seedJobs;
                needsSave = true;
            }

            if (needsSave) {
                await saveAllData();
                console.log('Seed data saved!');
            }
        }

        // Toggle rates visibility
        function toggleRates() {
            showRates = !showRates;
            document.querySelectorAll('.grid-header .rate').forEach(el => {
                el.classList.toggle('hidden', !showRates);
            });
            document.getElementById('toggleRatesBtn').textContent = showRates ? 'üëÅÔ∏è Hide Rates' : 'üëÅÔ∏è Show Rates';
        }

        // Toggle employee summary section
        function toggleEmployeeSummary() {
            employeeSummaryCollapsed = !employeeSummaryCollapsed;
            const header = document.querySelector('.employee-summary-header');
            const content = document.getElementById('employeeSummaryContent');
            
            if (employeeSummaryCollapsed) {
                header.classList.add('collapsed');
                content.classList.add('hidden');
            } else {
                header.classList.remove('collapsed');
                content.classList.remove('hidden');
            }
        }

        // Get worker rate for a specific job (or default from employee record)
        function getWorkerRate(workerName, jobName) {
            // First check if job has custom rate for this worker
            if (allData.jobs) {
                const job = Object.values(allData.jobs).find(j => 
                    j.payrollName === jobName || j.name === jobName
                );
                if (job && job.workerRates && job.workerRates[workerName] !== undefined) {
                    return job.workerRates[workerName];
                }
            }
            
            // Fall back to employee's default rate
            if (allData.employees) {
                const employee = Object.values(allData.employees).find(e => e.name === workerName);
                if (employee) {
                    return employee.rate || 0;
                }
            }
            
            return 0;
        }

        // Build workers list from employees
        function buildWorkerList() {
            workers = [];
            
            if (allData.employees) {
                // Get active employees, sorted by sortOrder
                const activeEmployees = Object.values(allData.employees)
                    .filter(e => e.status === 'active')
                    .sort((a, b) => (a.sortOrder || 999) - (b.sortOrder || 999));
                
                activeEmployees.forEach(emp => {
                    workers.push({ name: emp.name, rate: emp.rate });
                });
            }
        }

        // Build job sites from permanent sites + active jobs from JSONbin
        function buildJobSites() {
            jobSites = [...permanentJobSites];
            
            // Add active jobs from JSONbin
            if (allData.jobs) {
                Object.values(allData.jobs).forEach(job => {
                    // Only include active jobs
                    if (job.status === 'active') {
                        jobSites.push({
                            name: job.payrollName || job.name,
                            type: 'direct',
                            id: job.id
                        });
                    }
                });
            }
        }

        // Calculate and render employee weekly hours summary
        function updateEmployeeSummary() {
            const weekKey = getWeekKey(currentWeekStart);
            const weekData = allData[weekKey] || {};
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            // Calculate hours per employee
            const employeeHours = {};
            workers.forEach(w => {
                employeeHours[w.name] = 0;
            });
            
            // Sum hours from all days
            Object.values(weekData).forEach(dayData => {
                if (typeof dayData === 'object') {
                    Object.entries(dayData).forEach(([inputId, hours]) => {
                        const parts = inputId.split('_');
                        const workerName = parts[parts.length - 1];
                        if (employeeHours.hasOwnProperty(workerName)) {
                            employeeHours[workerName] += hours;
                        }
                    });
                }
            });
            
            // Calculate total
            let totalHours = 0;
            Object.values(employeeHours).forEach(h => totalHours += h);
            
            // Update header total
            document.getElementById('summaryTotalHours').textContent = `${totalHours} total hrs`;
            
            // Build display - only show employees with hours
            const container = document.getElementById('employeeSummaryList');
            let html = `<span class="summary-title">Week of ${formatDate(currentWeekStart)} - ${formatDate(weekEnd)}, ${currentWeekStart.getFullYear()}</span>`;
            
            let hasAnyHours = false;
            workers.forEach(w => {
                const hours = employeeHours[w.name];
                if (hours > 0) {
                    hasAnyHours = true;
                    html += `<div class="employee-line"><span class="employee-name">${w.name}:</span><span class="employee-hours">${hours} hrs</span></div>`;
                }
            });
            
            if (!hasAnyHours) {
                html += `<div style="color: #666; font-style: italic;">No hours logged this week</div>`;
            } else {
                html += `<div class="employee-line total-line"><span class="employee-name">TOTAL:</span><span class="employee-hours">${totalHours} hrs</span></div>`;
            }
            
            container.innerHTML = html;
        }

        // Generate plain text summary for copying/downloading
        function getEmployeeSummaryText() {
            const weekKey = getWeekKey(currentWeekStart);
            const weekData = allData[weekKey] || {};
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            // Calculate hours per employee
            const employeeHours = {};
            workers.forEach(w => {
                employeeHours[w.name] = 0;
            });
            
            Object.values(weekData).forEach(dayData => {
                if (typeof dayData === 'object') {
                    Object.entries(dayData).forEach(([inputId, hours]) => {
                        const parts = inputId.split('_');
                        const workerName = parts[parts.length - 1];
                        if (employeeHours.hasOwnProperty(workerName)) {
                            employeeHours[workerName] += hours;
                        }
                    });
                }
            });
            
            let totalHours = 0;
            let text = `Week of ${formatDate(currentWeekStart)} - ${formatDate(weekEnd)}, ${currentWeekStart.getFullYear()}\n\n`;
            
            workers.forEach(w => {
                const hours = employeeHours[w.name];
                if (hours > 0) {
                    text += `${w.name}: ${hours} hrs\n`;
                    totalHours += hours;
                }
            });
            
            if (totalHours > 0) {
                text += `\nTOTAL: ${totalHours} hrs`;
            }
            
            return text;
        }

        // Copy employee summary to clipboard
        function copyEmployeeSummary(event) {
            event.stopPropagation(); // Prevent toggle
            const text = getEmployeeSummaryText();
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied to clipboard!');
            });
        }

        // Download employee summary as txt file
        function downloadEmployeeSummary(event) {
            event.stopPropagation(); // Prevent toggle
            const text = getEmployeeSummaryText();
            const weekKey = getWeekKey(currentWeekStart);
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `payroll-hours-${weekKey}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Downloaded!');
        }

        // Init
        loadAllData().then(async () => {
            // Check and seed data if needed
            await checkAndSeedData();
            
            // Build dynamic lists
            buildWorkerList();
            buildJobSites();
            
            // Check if we have data to display
            if (workers.length === 0) {
                document.getElementById('timesheetGrid').innerHTML = `
                    <div class="no-data-message">
                        <h3>No Active Employees</h3>
                        <p>Add employees in the <a href="employees.html">Employees</a> page to start tracking payroll.</p>
                    </div>
                `;
                document.getElementById('loadingOverlay').classList.add('hidden');
                return;
            }
            
            const today = new Date();
            currentWeekStart = getWeekStart(today);
            const days = getWeekDays(currentWeekStart);
            const todayKey = today.toISOString().split('T')[0];
            selectedDayIndex = days.findIndex(d => d.key === todayKey);
            if (selectedDayIndex === -1) selectedDayIndex = 0;

            buildGrid();
            updateWeekDisplay();
            buildDayTabs();
            loadDayData();
            calculateWeekTotal();
            updateEmployeeSummary();
            
            // Hide loading overlay
            document.getElementById('loadingOverlay').classList.add('hidden');
        });

        // Storage
        async function loadAllData() {
            updateSaveStatus('loading');
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
                    headers: { 'X-Access-Key': JSONBIN_API_KEY }
                });
                const data = await response.json();
                allData = data.record || {};
                if (!allData.jobs) allData.jobs = {};
                if (!allData.employees) allData.employees = {};
                updateSaveStatus('saved');
            } catch (e) {
                console.log('Error loading:', e);
                allData = { jobs: {}, employees: {} };
                updateSaveStatus('saved');
            }
        }

        async function saveAllData() {
            updateSaveStatus('saving');
            try {
                await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-Access-Key': JSONBIN_API_KEY },
                    body: JSON.stringify(allData)
                });
                updateSaveStatus('saved');
            } catch (e) {
                console.error('Save failed:', e);
                updateSaveStatus('error');
            }
        }

        function updateSaveStatus(status) {
            const el = document.getElementById('saveStatus');
            if (status === 'loading') { el.className = 'save-status saving'; el.innerHTML = '<span>‚óè</span> Loading...'; }
            else if (status === 'saving') { el.className = 'save-status saving'; el.innerHTML = '<span>‚óè</span> Saving...'; }
            else if (status === 'saved') { el.className = 'save-status saved'; el.innerHTML = '<span>‚óè</span> All changes saved'; }
            else { el.className = 'save-status'; el.innerHTML = '<span>‚óè</span> Save failed'; }
        }

        // Date utils
        function getWeekStart(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            const day = d.getDay();
            const diff = (day >= 5) ? (day - 5) : (day + 2);
            d.setDate(d.getDate() - diff);
            return d;
        }

        function getWeekDays(weekStart) {
            const days = [];
            const dayNames = ['Fri', 'Sat', 'Sun', 'Mon', 'Tue', 'Wed', 'Thu'];
            for (let i = 0; i < 7; i++) {
                const d = new Date(weekStart);
                d.setDate(d.getDate() + i);
                days.push({ date: d, name: dayNames[i], key: d.toISOString().split('T')[0] });
            }
            return days;
        }

        function getWeekKey(weekStart) { return weekStart.toISOString().split('T')[0]; }

        function formatDate(date, format = 'short') {
            const options = format === 'long' 
                ? { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }
                : { month: 'short', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        // Week navigation
        function updateWeekDisplay() {
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            document.getElementById('weekPeriod').textContent = `${formatDate(currentWeekStart)} - ${formatDate(weekEnd)}`;
            document.getElementById('weekYear').textContent = currentWeekStart.getFullYear();
        }

        function prevWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            selectedDayIndex = 0;
            updateWeekDisplay(); buildDayTabs(); loadDayData(); calculateWeekTotal(); updateEmployeeSummary();
        }

        function nextWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            selectedDayIndex = 0;
            updateWeekDisplay(); buildDayTabs(); loadDayData(); calculateWeekTotal(); updateEmployeeSummary();
        }

        // Day tabs
        function buildDayTabs() {
            const container = document.getElementById('dayTabs');
            const days = getWeekDays(currentWeekStart);
            container.innerHTML = days.map((day, i) => `
                <button class="day-tab ${i === selectedDayIndex ? 'active' : ''}" onclick="selectDay(${i})">
                    <div class="day-name">${day.name}</div>
                    <div class="day-date">${day.date.getDate()}</div>
                </button>
            `).join('');
        }

        function selectDay(index) {
            selectedDayIndex = index;
            document.querySelectorAll('.day-tab').forEach((tab, i) => tab.classList.toggle('active', i === index));
            loadDayData();
        }

        // Grid
        function buildGrid() {
            const grid = document.getElementById('timesheetGrid');
            const numCols = workers.length + 1; // +1 for job site column
            grid.style.gridTemplateColumns = `130px repeat(${workers.length}, 1fr)`;
            
            let html = '<div class="grid-header job-col">Job Site</div>';
            workers.forEach(w => {
                html += `<div class="grid-header">${w.name}<span class="rate ${showRates ? '' : 'hidden'}">$${w.rate}/hr</span></div>`;
            });

            jobSites.forEach(job => {
                const jobKey = job.name.replace(/[^a-zA-Z]/g, '');
                
                // Create job cell - clickable if it has an id (linked to jobs.html)
                let jobCellContent;
                if (job.id) {
                    jobCellContent = `<a href="job.html?id=${job.id}" class="job-link ${job.type}">${job.name}</a>`;
                } else {
                    jobCellContent = job.name;
                }
                
                html += `<div class="grid-row"><div class="grid-cell job-cell ${job.type}">${jobCellContent}</div>`;
                workers.forEach(w => {
                    const inputId = `${jobKey}_${w.name}`;
                    const rate = getWorkerRate(w.name, job.name);
                    html += `<div class="grid-cell"><input type="number" class="hour-input" id="${inputId}" data-worker="${w.name}" data-job="${job.name}" data-type="${job.type}" data-rate="${rate}" placeholder="-" min="0" max="24" step="0.5" oninput="onInput()"></div>`;
                });
                html += `</div>`;
            });

            html += `<div class="grid-row totals-row"><div class="grid-cell job-cell">TOTALS</div>`;
            workers.forEach(w => html += `<div class="grid-cell"><span class="total-value" id="total_${w.name}">0</span></div>`);
            html += `</div>`;

            grid.innerHTML = html;
        }

        function loadDayData() {
            const days = getWeekDays(currentWeekStart);
            const day = days[selectedDayIndex];
            const weekKey = getWeekKey(currentWeekStart);

            document.getElementById('selectedDayDisplay').textContent = formatDate(day.date, 'long');
            document.querySelectorAll('.hour-input').forEach(input => input.value = '');

            const dayData = allData[weekKey]?.[day.key] || {};
            Object.entries(dayData).forEach(([key, hours]) => {
                const input = document.getElementById(key);
                if (input && hours) input.value = hours;
            });

            calculateTotals();
        }

        function onInput() {
            calculateTotals();
            calculateWeekTotal();
            updateEmployeeSummary();
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveDay, 500);
        }

        async function saveDay() {
            const days = getWeekDays(currentWeekStart);
            const day = days[selectedDayIndex];
            const weekKey = getWeekKey(currentWeekStart);

            if (!allData[weekKey]) allData[weekKey] = {};
            const dayData = {};
            document.querySelectorAll('.hour-input').forEach(input => {
                const hours = parseFloat(input.value) || 0;
                if (hours > 0) dayData[input.id] = hours;
            });
            allData[weekKey][day.key] = dayData;
            await saveAllData();
        }

        function calculateTotals() {
            let totalHours = 0, directCost = 0, indirectCost = 0;
            workers.forEach(w => {
                let workerTotal = 0;
                document.querySelectorAll(`input[data-worker="${w.name}"]`).forEach(input => {
                    const hours = parseFloat(input.value) || 0;
                    workerTotal += hours;
                    const rate = getWorkerRate(w.name, input.dataset.job);
                    if (input.dataset.type === 'direct') directCost += hours * rate;
                    else indirectCost += hours * rate;
                });
                const totalEl = document.getElementById(`total_${w.name}`);
                if (totalEl) totalEl.textContent = workerTotal || '0';
                totalHours += workerTotal;
            });
            document.getElementById('dayHours').textContent = totalHours;
            document.getElementById('directLabor').textContent = '$' + directCost.toLocaleString();
            document.getElementById('indirectLabor').textContent = '$' + indirectCost.toLocaleString();
        }

        function calculateWeekTotal() {
            const weekKey = getWeekKey(currentWeekStart);
            const weekData = allData[weekKey] || {};
            let weekTotal = 0;
            Object.values(weekData).forEach(dayData => {
                if (typeof dayData === 'object') {
                    Object.entries(dayData).forEach(([inputId, hours]) => {
                        const parts = inputId.split('_');
                        const workerName = parts[parts.length - 1];
                        const jobKey = parts.slice(0, -1).join('_');
                        // Find job name from jobKey
                        const job = jobSites.find(j => j.name.replace(/[^a-zA-Z]/g, '') === jobKey);
                        const jobName = job ? job.name : jobKey;
                        const rate = getWorkerRate(workerName, jobName);
                        weekTotal += hours * rate;
                    });
                }
            });
            document.getElementById('weekTotal').textContent = '$' + weekTotal.toLocaleString();
        }

        function clearDay() {
            document.querySelectorAll('.hour-input').forEach(input => input.value = '');
            calculateTotals();
            saveDay();
            calculateWeekTotal();
            updateEmployeeSummary();
        }

        // Tabs
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            if (tab === 'timesheet') {
                document.querySelector('.tab:nth-child(1)').classList.add('active');
                document.getElementById('timesheetTab').classList.add('active');
            } else {
                document.querySelector('.tab:nth-child(2)').classList.add('active');
                document.getElementById('historyTab').classList.add('active');
                renderHistory();
            }
        }

        function renderHistory() {
            const container = document.getElementById('historyList');
            const weeks = Object.keys(allData).filter(k => k !== 'bids' && k !== 'jobs' && k !== 'employees' && k.match(/^\d{4}-\d{2}-\d{2}$/)).sort().reverse();
            if (weeks.length === 0) {
                container.innerHTML = '<div class="no-history">No payroll history yet.</div>';
                return;
            }
            const currentWeekKey = getWeekKey(currentWeekStart);
            container.innerHTML = weeks.map(weekKey => {
                const weekStart = new Date(weekKey + 'T00:00:00');
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                let totalHours = 0, totalCost = 0;
                const weekData = allData[weekKey] || {};
                Object.values(weekData).forEach(dayData => {
                    if (typeof dayData === 'object') {
                        Object.entries(dayData).forEach(([inputId, hours]) => {
                            totalHours += hours;
                            const parts = inputId.split('_');
                            const workerName = parts[parts.length - 1];
                            const jobKey = parts.slice(0, -1).join('_');
                            const job = jobSites.find(j => j.name.replace(/[^a-zA-Z]/g, '') === jobKey);
                            const jobName = job ? job.name : jobKey;
                            const rate = getWorkerRate(workerName, jobName);
                            totalCost += hours * rate;
                        });
                    }
                });
                return `
                    <div class="history-card ${weekKey === currentWeekKey ? 'current' : ''}" onclick="goToWeek('${weekKey}')">
                        <div class="history-info">
                            <h3>${formatDate(weekStart)} - ${formatDate(weekEnd)}, ${weekStart.getFullYear()}</h3>
                            <p>${weekKey === currentWeekKey ? '‚Üê Current Week' : 'Click to view'}</p>
                        </div>
                        <div class="history-stats">
                            <div class="hours">${totalHours} hrs</div>
                            <div class="cost">$${totalCost.toLocaleString()}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function goToWeek(weekKey) {
            currentWeekStart = new Date(weekKey + 'T00:00:00');
            selectedDayIndex = 0;
            switchTab('timesheet');
            updateWeekDisplay(); buildDayTabs(); loadDayData(); calculateWeekTotal(); updateEmployeeSummary();
        }

        // Report
        function generateReport() {
            const weekKey = getWeekKey(currentWeekStart);
            const weekData = allData[weekKey] || {};
            const days = getWeekDays(currentWeekStart);
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);

            let report = `SPENCER'S MASONRY\nWEEKLY PAYROLL REPORT\n${'‚ïê'.repeat(45)}\n`;
            report += `Week: ${formatDate(currentWeekStart)} - ${formatDate(weekEnd)}, ${currentWeekStart.getFullYear()}\n\n`;

            let weekTotalHours = 0, weekDirectCost = 0, weekIndirectCost = 0;
            days.forEach(day => {
                const dayData = weekData[day.key] || {};
                if (Object.keys(dayData).length === 0) return;
                report += `${formatDate(day.date, 'long')}\n${'-'.repeat(35)}\n`;
                const byJob = {};
                Object.entries(dayData).forEach(([inputId, hours]) => {
                    const parts = inputId.split('_');
                    const workerName = parts[parts.length - 1];
                    const jobName = parts.slice(0, -1).join('_');
                    const job = jobSites.find(j => j.name.replace(/[^a-zA-Z]/g, '') === jobName);
                    const actualJobName = job ? job.name : jobName;
                    if (!byJob[actualJobName]) byJob[actualJobName] = [];
                    byJob[actualJobName].push({ worker: workerName, hours });
                });
                Object.entries(byJob).forEach(([jobName, entries]) => {
                    const job = jobSites.find(j => j.name === jobName);
                    report += `  ${jobName}${job?.type === 'indirect' ? ' (Indirect)' : ''}\n`;
                    entries.forEach(e => {
                        report += `    ${e.worker}: ${e.hours} hrs\n`;
                        weekTotalHours += e.hours;
                        const rate = getWorkerRate(e.worker, jobName);
                        if (job?.type === 'indirect') weekIndirectCost += e.hours * rate;
                        else weekDirectCost += e.hours * rate;
                    });
                });
                report += '\n';
            });

            report += `${'‚ïê'.repeat(45)}\nWEEKLY SUMMARY\n`;
            report += `  Total Hours: ${weekTotalHours}\n`;
            report += `  Direct Labor: $${weekDirectCost.toLocaleString()}\n`;
            report += `  Indirect Labor: $${weekIndirectCost.toLocaleString()}\n`;
            report += `  Total Labor Cost: $${(weekDirectCost + weekIndirectCost).toLocaleString()}\n`;
            report += `${'‚ïê'.repeat(45)}`;

            document.getElementById('previewBox').textContent = report;
            document.getElementById('modalOverlay').classList.add('show');
        }

        // Modal
        function closeModal() { document.getElementById('modalOverlay').classList.remove('show'); }
        function copyReport() {
            navigator.clipboard.writeText(document.getElementById('previewBox').textContent).then(() => {
                showToast('Copied to clipboard!');
                closeModal();
            });
        }
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }
        document.getElementById('modalOverlay').addEventListener('click', function(e) { if (e.target === this) closeModal(); });
    </script>
</body>
</html>
